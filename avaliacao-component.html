<!-- ============================================================================ -->
<!-- COMPONENTE DE AVALIAÇÃO DE ATENDIMENTO -->
<!-- ============================================================================ -->
<!-- Este componente pode ser incluído em qualquer página -->
<!-- Versão: 1.0.0 -->
<!-- ============================================================================ -->

<!-- Estilos do Botão Flutuante e Modal -->
<style>
    /* Botão Flutuante */
    .avaliacao-float-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, #1DC56F 0%, #0F8BD6 100%);
        border-radius: 50%;
        box-shadow: 0 4px 20px rgba(15, 139, 214, 0.4);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        animation: pulse 2s infinite;
    }
    
    .avaliacao-float-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 30px rgba(15, 139, 214, 0.6);
    }
    
    .avaliacao-float-btn .icon {
        font-size: 32px;
        animation: bounce 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 4px 20px rgba(15, 139, 214, 0.4);
        }
        50% {
            box-shadow: 0 4px 30px rgba(15, 139, 214, 0.7);
        }
    }
    
    @keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-5px);
        }
    }
    
    /* Tooltip do Botão */
    .avaliacao-float-btn::before {
        content: "Avalie seu atendimento!";
        position: absolute;
        right: 80px;
        background: #0F2740;
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .avaliacao-float-btn:hover::before {
        opacity: 1;
    }
    
    /* Overlay do Modal */
    .avaliacao-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
        padding: 20px;
        overflow-y: auto;
    }
    
    .avaliacao-modal-overlay.show {
        display: flex;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
    
    /* Modal */
    .avaliacao-modal {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        animation: slideUp 0.3s ease;
        border-top: 6px solid #1DC56F;
        position: relative;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Botão Fechar */
    .avaliacao-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #f5f5f5;
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        font-weight: bold;
        color: #666;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .avaliacao-close-btn:hover {
        background: #e0e0e0;
        color: #333;
        transform: rotate(90deg);
    }
    
    /* Título do Modal */
    .avaliacao-modal h2 {
        margin: 0 0 10px;
        color: #0F2740;
        font-size: 24px;
        font-weight: 900;
        text-align: center;
    }
    
    .avaliacao-modal .subtitle {
        text-align: center;
        color: #6B87A4;
        font-size: 14px;
        margin-bottom: 25px;
    }
    
    /* Formulário */
    .avaliacao-form-group {
        margin-bottom: 20px;
    }
    
    .avaliacao-form-group label {
        display: block;
        margin-bottom: 8px;
        color: #0F2740;
        font-weight: 700;
        font-size: 14px;
    }
    
    .avaliacao-form-group label .required {
        color: #ff4444;
    }
    
    .avaliacao-form-group input,
    .avaliacao-form-group select,
    .avaliacao-form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #DDEAF7;
        border-radius: 10px;
        font-size: 14px;
        font-family: inherit;
        transition: all 0.3s;
    }
    
    .avaliacao-form-group input:focus,
    .avaliacao-form-group select:focus,
    .avaliacao-form-group textarea:focus {
        outline: none;
        border-color: #0F8BD6;
        box-shadow: 0 0 0 3px rgba(15, 139, 214, 0.1);
    }
    
    .avaliacao-form-group textarea {
        resize: vertical;
        min-height: 80px;
    }
    
    /* Rating Stars */
    .star-rating {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }
    
    .star-rating input[type="radio"] {
        display: none;
    }
    
    .star-rating label {
        font-size: 32px;
        cursor: pointer;
        transition: all 0.2s;
        color: #ddd;
    }
    
    .star-rating label:hover,
    .star-rating label:hover ~ label,
    .star-rating input[type="radio"]:checked ~ label {
        color: #FFD700;
        transform: scale(1.1);
    }
    
    /* NPS Scale */
    .nps-scale {
        display: flex;
        gap: 5px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    
    .nps-scale input[type="radio"] {
        display: none;
    }
    
    .nps-scale label {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #DDEAF7;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        transition: all 0.3s;
        background: white;
    }
    
    .nps-scale label:hover {
        border-color: #0F8BD6;
        transform: scale(1.1);
    }
    
    .nps-scale input[type="radio"]:checked + label {
        background: #0F8BD6;
        color: white;
        border-color: #0F8BD6;
    }
    
    .nps-labels {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #6B87A4;
        margin-top: 8px;
    }
    
    /* Botão Enviar */
    .avaliacao-submit-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #1DC56F 0%, #0F8BD6 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 20px;
    }
    
    .avaliacao-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(15, 139, 214, 0.4);
    }
    
    .avaliacao-submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Responsivo */
    @media (max-width: 600px) {
        .avaliacao-modal {
            padding: 20px;
            border-radius: 15px;
        }
        
        .avaliacao-modal h2 {
            font-size: 20px;
        }
        
        .star-rating label {
            font-size: 28px;
        }
        
        .nps-scale label {
            width: 35px;
            height: 35px;
            font-size: 13px;
        }
        
        .avaliacao-float-btn::before {
            display: none;
        }
    }
</style>

<!-- Botão Flutuante -->
<div class="avaliacao-float-btn" id="avaliacaoFloatBtn" onclick="abrirModalAvaliacao()">
    <span class="icon">⭐</span>
</div>

<!-- Modal de Avaliação -->
<div class="avaliacao-modal-overlay" id="avaliacaoModalOverlay">
    <div class="avaliacao-modal">
        <button class="avaliacao-close-btn" onclick="fecharModalAvaliacao()">✕</button>
        
        <h2>⭐ Avalie seu Atendimento</h2>
        <p class="subtitle">Sua opinião é muito importante para melhorarmos nossos serviços!</p>
        
        <form id="avaliacaoForm">
            <!-- Dados do Paciente -->
            <div class="avaliacao-form-group">
                <label>Nome Completo <span class="required">*</span></label>
                <input type="text" name="nome_completo" required>
            </div>
            
            <div class="avaliacao-form-group">
                <label>CPF <span class="required">*</span></label>
                <input type="text" name="cpf" placeholder="000.000.000-00" required>
            </div>
            
            <div class="avaliacao-form-group">
                <label>Celular <span class="required">*</span></label>
                <input type="text" name="celular" placeholder="(00) 00000-0000" required>
            </div>
            
            <div class="avaliacao-form-group">
                <label>E-mail</label>
                <input type="email" name="email" placeholder="seuemail@exemplo.com">
            </div>
            
            <!-- Dados do Atendimento -->
            <div class="avaliacao-form-group">
                <label>Unidade onde foi atendido <span class="required">*</span></label>
                <select name="unidade_atendimento" required>
                    <option value="">Selecione...</option>
                    <option value="Marabá">Marabá</option>
                    <option value="Alecrim">Alecrim</option>
                    <option value="Vila Central">Vila Central</option>
                    <option value="Japeri Centro">Japeri Centro</option>
                    <option value="Chacrinha">Chacrinha</option>
                    <option value="CEO">CEO - Centro de Especialidades Odontológicas</option>
                    <option value="Unidade Odontológica móvel do Rio D'ouro">Unidade Odontológica móvel do Rio D'ouro</option>
                    <option value="Unidade Odontológica móvel do Laranjal">Unidade Odontológica móvel do Laranjal</option>
                    <option value="Unidade Odontológica móvel do Marajoara">Unidade Odontológica móvel do Marajoara</option>
                </select>
            </div>
            
            <div class="avaliacao-form-group">
                <label>Data do Atendimento <span class="required">*</span></label>
                <input type="date" name="data_atendimento" required>
            </div>
            
            <div class="avaliacao-form-group">
                <label>Tipo de Atendimento <span class="required">*</span></label>
                <select name="tipo_atendimento" required>
                    <option value="">Selecione...</option>
                    <option value="Consulta">Consulta</option>
                    <option value="Procedimento">Procedimento</option>
                    <option value="Urgência">Urgência</option>
                    <option value="Retorno">Retorno</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>
            
            <!-- Avaliações com Estrelas -->
            <div class="avaliacao-form-group">
                <label>Como você avalia o atendimento geral? <span class="required">*</span></label>
                <div class="star-rating">
                    <input type="radio" name="nota_atendimento" id="atend5" value="5" required>
                    <label for="atend5">⭐</label>
                    <input type="radio" name="nota_atendimento" id="atend4" value="4">
                    <label for="atend4">⭐</label>
                    <input type="radio" name="nota_atendimento" id="atend3" value="3">
                    <label for="atend3">⭐</label>
                    <input type="radio" name="nota_atendimento" id="atend2" value="2">
                    <label for="atend2">⭐</label>
                    <input type="radio" name="nota_atendimento" id="atend1" value="1">
                    <label for="atend1">⭐</label>
                </div>
            </div>
            
            <div class="avaliacao-form-group">
                <label>Como você avalia o profissional que te atendeu? <span class="required">*</span></label>
                <div class="star-rating">
                    <input type="radio" name="nota_profissional" id="prof5" value="5" required>
                    <label for="prof5">⭐</label>
                    <input type="radio" name="nota_profissional" id="prof4" value="4">
                    <label for="prof4">⭐</label>
                    <input type="radio" name="nota_profissional" id="prof3" value="3">
                    <label for="prof3">⭐</label>
                    <input type="radio" name="nota_profissional" id="prof2" value="2">
                    <label for="prof2">⭐</label>
                    <input type="radio" name="nota_profissional" id="prof1" value="1">
                    <label for="prof1">⭐</label>
                </div>
            </div>
            
            <div class="avaliacao-form-group">
                <label>Como você avalia as instalações da unidade? <span class="required">*</span></label>
                <div class="star-rating">
                    <input type="radio" name="nota_instalacoes" id="inst5" value="5" required>
                    <label for="inst5">⭐</label>
                    <input type="radio" name="nota_instalacoes" id="inst4" value="4">
                    <label for="inst4">⭐</label>
                    <input type="radio" name="nota_instalacoes" id="inst3" value="3">
                    <label for="inst3">⭐</label>
                    <input type="radio" name="nota_instalacoes" id="inst2" value="2">
                    <label for="inst2">⭐</label>
                    <input type="radio" name="nota_instalacoes" id="inst1" value="1">
                    <label for="inst1">⭐</label>
                </div>
            </div>
            
            <div class="avaliacao-form-group">
                <label>Como você avalia o tempo de espera? <span class="required">*</span></label>
                <div class="star-rating">
                    <input type="radio" name="nota_tempo_espera" id="tempo5" value="5" required>
                    <label for="tempo5">⭐</label>
                    <input type="radio" name="nota_tempo_espera" id="tempo4" value="4">
                    <label for="tempo4">⭐</label>
                    <input type="radio" name="nota_tempo_espera" id="tempo3" value="3">
                    <label for="tempo3">⭐</label>
                    <input type="radio" name="nota_tempo_espera" id="tempo2" value="2">
                    <label for="tempo2">⭐</label>
                    <input type="radio" name="nota_tempo_espera" id="tempo1" value="1">
                    <label for="tempo1">⭐</label>
                </div>
            </div>
            
            <!-- NPS -->
            <div class="avaliacao-form-group">
                <label>De 0 a 10, quanto você recomendaria nosso serviço? <span class="required">*</span></label>
                <div class="nps-scale">
                    <input type="radio" name="recomendaria_servico" id="nps0" value="0" required>
                    <label for="nps0">0</label>
                    <input type="radio" name="recomendaria_servico" id="nps1" value="1">
                    <label for="nps1">1</label>
                    <input type="radio" name="recomendaria_servico" id="nps2" value="2">
                    <label for="nps2">2</label>
                    <input type="radio" name="recomendaria_servico" id="nps3" value="3">
                    <label for="nps3">3</label>
                    <input type="radio" name="recomendaria_servico" id="nps4" value="4">
                    <label for="nps4">4</label>
                    <input type="radio" name="recomendaria_servico" id="nps5" value="5">
                    <label for="nps5">5</label>
                    <input type="radio" name="recomendaria_servico" id="nps6" value="6">
                    <label for="nps6">6</label>
                    <input type="radio" name="recomendaria_servico" id="nps7" value="7">
                    <label for="nps7">7</label>
                    <input type="radio" name="recomendaria_servico" id="nps8" value="8">
                    <label for="nps8">8</label>
                    <input type="radio" name="recomendaria_servico" id="nps9" value="9">
                    <label for="nps9">9</label>
                    <input type="radio" name="recomendaria_servico" id="nps10" value="10">
                    <label for="nps10">10</label>
                </div>
                <div class="nps-labels">
                    <span>Não recomendaria</span>
                    <span>Recomendaria muito</span>
                </div>
            </div>
            
            <!-- Feedback Textual -->
            <div class="avaliacao-form-group">
                <label>O que você achou de positivo?</label>
                <textarea name="pontos_positivos" placeholder="Conte-nos o que você gostou..."></textarea>
            </div>
            
            <div class="avaliacao-form-group">
                <label>O que você achou de negativo?</label>
                <textarea name="pontos_negativos" placeholder="Conte-nos o que pode melhorar..."></textarea>
            </div>
            
            <div class="avaliacao-form-group">
                <label>Sugestões de melhoria</label>
                <textarea name="sugestoes" placeholder="Suas sugestões são muito importantes..."></textarea>
            </div>
            
            <!-- Autorização de Contato -->
            <div class="avaliacao-form-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" name="autoriza_contato" style="width: auto;">
                    <span style="font-weight: 400;">Autorizo contato para esclarecimentos sobre esta avaliação</span>
                </label>
            </div>
            
            <button type="submit" class="avaliacao-submit-btn">Enviar Avaliação</button>
        </form>
    </div>
</div>

<!-- Script do Componente -->
<script>
    // Funções para abrir/fechar modal
    function abrirModalAvaliacao() {
        document.getElementById('avaliacaoModalOverlay').classList.add('show');
        document.body.style.overflow = 'hidden';
    }
    
    function fecharModalAvaliacao() {
        document.getElementById('avaliacaoModalOverlay').classList.remove('show');
        document.body.style.overflow = '';
    }
    
    // Fechar ao clicar fora do modal
    document.getElementById('avaliacaoModalOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
            fecharModalAvaliacao();
        }
    });
    
    // Máscaras para CPF e Celular
    document.querySelector('input[name="cpf"]').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        e.target.value = value;
    });
    
    document.querySelector('input[name="celular"]').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
        value = value.replace(/(\d)(\d{4})$/, '$1-$2');
        e.target.value = value;
    });
    
    // Configurar data máxima (hoje)
    const hoje = new Date().toISOString().split('T')[0];
    document.querySelector('input[name="data_atendimento"]').max = hoje;
    
    // Submissão do formulário
    document.getElementById('avaliacaoForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('.avaliacao-submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';
        
        try {
            const formData = new FormData(e.target);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'autoriza_contato') {
                    data[key] = formData.get(key) === 'on';
                } else {
                    data[key] = value;
                }
            }
            
            // Limpar máscaras
            data.cpf = data.cpf.replace(/\D/g, '');
            data.celular = data.celular.replace(/\D/g, '');
            
            // Converter notas para inteiros
            data.nota_atendimento = parseInt(data.nota_atendimento);
            data.nota_profissional = parseInt(data.nota_profissional);
            data.nota_instalacoes = parseInt(data.nota_instalacoes);
            data.nota_tempo_espera = parseInt(data.nota_tempo_espera);
            data.recomendaria_servico = parseInt(data.recomendaria_servico);
            
            // Inserir no Supabase
            const { error } = await supabaseClient
                .from('avaliacoes')
                .insert([data]);
            
            if (error) throw error;
            
            // Sucesso
            alert('✅ Avaliação enviada com sucesso! Muito obrigado pelo seu feedback!');
            e.target.reset();
            fecharModalAvaliacao();
            
        } catch (error) {
            console.error('Erro ao enviar avaliação:', error);
            alert('❌ Erro ao enviar avaliação. Por favor, tente novamente.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Enviar Avaliação';
        }
    });
</script>
