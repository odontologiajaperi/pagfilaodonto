<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Painel ‚Äî Fila de Pacientes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Inter:wght@500;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#EAF5FF; --panel:#FFFFFF; --line:#DDEAF7; --fg:#1B304A; --muted:#6B87A4;
      --brand-blue:#3BB3FF; --brand-green:#6CDC64; --yellow:#FFF070; --chip:#F3FAFF; --accent:#0F8BD6;
    }
    *{box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
    .wrap{max-width:1060px;margin:0 auto;padding:20px}
    .hero{position:relative;border:1px solid var(--line);border-radius:24px;background:linear-gradient(180deg,#F7FBFF 0%,#F0F8FF 100%);padding:28px 20px 24px;overflow:hidden}
    .hero::after{content:"";position:absolute;inset:-20px -10px auto auto;width:360px;height:360px;opacity:.08;background:
      radial-gradient(circle at 20% 30%, #2aa7ea 10px, transparent 11px),
      radial-gradient(circle at 60% 20%, #6ddc5c 8px, transparent 9px),
      radial-gradient(circle at 75% 55%, #2aa7ea 7px, transparent 8px),
      radial-gradient(circle at 40% 70%, #6ddc5c 12px, transparent 13px);
      filter: blur(2px);pointer-events:none}
    .hero-top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--accent)}
    .brand .logo{width:38px;height:38px;border-radius:10px;background:#D7F2FF;border:1px solid var(--line);display:grid;place-items:center;font-size:18px}
    .hero-title{margin:8px 0 0;line-height:1.05;font-family:"Baloo 2",system-ui,sans-serif;display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap}
    .hero-title .eu{color:var(--brand-blue);font-size:clamp(36px,6.2vw,64px);font-weight:800;transform:rotate(-2deg)}
    .hero-title .sou{color:var(--brand-green);font-size:clamp(36px,6.2vw,64px);font-weight:800;transform:rotate(2deg)}
    .hero-title .a{color:var(--muted);font-size:clamp(18px,2.8vw,28px);margin-left:2px;transform:translateY(-4px)}
    .hero-bar{display:inline-block;margin-top:8px;padding:8px 14px;background:var(--yellow);border-radius:10px;box-shadow:0 4px 0 rgba(0,0,0,.04);transform:rotate(-1deg)}
    .hero-bar span{display:inline-block;font-weight:900;letter-spacing:.6px;color:#15a0d6;font-size:clamp(18px,3.6vw,28px)}

    .panel{margin-top:16px;border:1px solid var(--line);background:var(--panel);border-radius:20px;padding:16px}
    .toolbar{display:grid;grid-template-columns:1fr 1fr auto;gap:12px;margin-bottom:10px}
    @media (max-width:700px){.toolbar{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
    select,button{width:100%;appearance:none;border:1px solid var(--line);background:#fff;color:var(--fg);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    select:focus,button:hover{outline:none;border-color:#cfe3f7}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:4px 2px 14px}
    .chip{background:var(--chip);border:1px solid var(--line);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:13px}

    .sectionTitle{margin:14px 2px 10px;font-size:14px;color:var(--muted);font-weight:800;letter-spacing:.3px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media (max-width:700px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--line);background:#fff;border-radius:16px;padding:16px}
    .label{font-size:14px;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:8px}
    .value{font-size:clamp(40px,7.2vw,68px);font-weight:900;line-height:1;color:#15a0d6;letter-spacing:.4px;background:linear-gradient(0deg,#fff 0 40%, var(--yellow) 40% 100%);display:inline-block;padding:4px 8px;border-radius:10px}
    .sub{font-size:13px;color:var(--muted);margin-top:8px}
    .list{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:8px}
    @media (max-width:700px){.list{grid-template-columns:1fr}}
    .row{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
    .row b{font-weight:800}
    .error{color:#d64545;font-size:14px;display:none;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <div class="hero-top">
        <div class="brand"><div class="logo">ü¶∑</div><div>Prefeitura de Japeri ‚Ä¢ Sa√∫de</div></div>
      </div>
      <h1 class="hero-title"><span class="eu">eu</span><span class="sou">sou</span><span class="a">a</span></h1>
      <div class="hero-bar"><span>SA√öDE BUCAL</span></div>
    </section>

    <section class="panel">
      <div class="toolbar">
        <div><label for="postoSelect">Posto</label><select id="postoSelect"></select></div>
        <div><label for="mesSelect">M√™s</label><select id="mesSelect"></select></div>
        <div style="align-self:end;display:flex;gap:8px"><button id="refreshBtn">Recarregar</button></div>
      </div>

      <div class="chips">
        <div class="chip" id="pillPosto">Posto: ‚Äî</div>
        <div class="chip" id="pillMes">M√™s: ‚Äî</div>
        <div class="chip" id="pillStamp">Atualizado: ‚Äî</div>
      </div>

      <div class="sectionTitle">Total do m√™s selecionado</div>
      <div class="grid">
        <div class="card">
          <div class="label">üïí Em espera</div>
          <div id="filaMes" class="value">‚Äî</div>
          <div id="filaMesObs" class="sub"></div>
        </div>
        <div class="card">
          <div class="label">üìÖ Agendados (total fixo)</div>
          <div id="agTotal" class="value">‚Äî</div>
          <div class="sub">N√£o muda com filtros. Edite em <code>agendados_total</code>.</div>
        </div>
      </div>

      <div class="sectionTitle">Acumulados</div>
      <div class="grid">
        <div class="card">
          <div class="label">üè• Em espera ‚Äî Acumulado do posto (todos os meses)</div>
          <div id="postoAcumFila" class="value">‚Äî</div>
          <div id="postoAcumFilaObs" class="sub"></div>
        </div>
        <div class="card">
          <div class="label">üåé Em espera ‚Äî Acumulado geral (todos os postos + meses)</div>
          <div id="geralAcumFila" class="value">‚Äî</div>
          <div id="geralAcumFilaObs" class="sub"></div>
        </div>
      </div>

      <div class="sectionTitle">Resumo por posto (em espera ‚Äî soma de todos os meses)</div>
      <div id="postoResumo" class="list"></div>

      <div id="error" class="error"></div>
    </section>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const elPosto=$('#postoSelect'), elMes=$('#mesSelect'), elBtn=$('#refreshBtn');
    const elPPosto=$('#pillPosto'), elPMes=$('#pillMes'), elPStamp=$('#pillStamp');
    const elFilaMes=$('#filaMes'), elFilaMesObs=$('#filaMesObs');
    const elAgTotal=$('#agTotal');
    const elPostoAcum=$('#postoAcumFila'), elPostoAcumObs=$('#postoAcumFilaObs');
    const elGeralAcum=$('#geralAcumFila'), elGeralAcumObs=$('#geralAcumFilaObs');
    const elResumo=$('#postoResumo'), elErr=$('#error');
    let DATA=null;

    // helpers
    const nomes=["","jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"];
    function parseRank(k){
      const m=/^(\d{4})-(\d{2})(?:-(\d{2}))?$/.exec(k);
      if(m){ const y=+m[1], m1=+m[2], m2=m[3]?+m[3]:null; return y*12 + m1 + (m2?0.5:0); }
      const s=k.toLowerCase(); if(/fev/.test(s))return 2; if(/mar/.test(s))return 3; if(/mai/.test(s))return 5;
      if(/jun/.test(s))return 6; if(/jul.*ago|jul\/ago|jul-ago/.test(s))return 7.5; if(/ago/.test(s))return 8; if(/set/.test(s))return 9; return 0;
    }
    function labelMes(k){
      const m=/^(\d{4})-(\d{2})(?:-(\d{2}))?$/.exec(k);
      if(m){ const y=m[1], m1=+m[2], m2=m[3]?+m[3]:null; return m2?`${nomes[m1]}+${nomes[m2]}/${y}`:`${nomes[m1]}/${y}`; }
      return k;
    }
    function stamp(iso){ try{ const d=new Date(iso); const two=n=>String(n).padStart(2,'0'); return `${two(d.getDate())}/${two(d.getMonth()+1)}/${d.getFullYear()} ${two(d.getHours())}:${two(d.getMinutes())}`;}catch{return'‚Äî'} }
    function animate(el,to){ const from=Number(el.textContent.replace(/\D/g,''))||0; const target=Number(to)||0; const diff=target-from; const steps=16; if(diff===0){el.textContent=String(target);return;} let i=0; const tick=()=>{i++; el.textContent=String(Math.round(from+diff*(i/steps))); if(i<steps) requestAnimationFrame(tick);}; requestAnimationFrame(tick); }

    function getPostos(){ return Object.keys(DATA.postos||{}).sort((a,b)=>a.localeCompare(b,'pt')); }
    function getMeses(){
      const set=new Set();
      for(const p of Object.values(DATA.postos||{})) for(const k of Object.keys(p)) set.add(k);
      return [...set].sort((a,b)=>parseRank(b)-parseRank(a));
    }
    function somaPostoMes(p,m){ return Number((DATA.postos?.[p]||{})[m]?.fila||0); }
    function somaMesFila(m){ let t=0; for(const p of Object.keys(DATA.postos||{})) t+=somaPostoMes(p,m); return t; }
    function somaPostoTodos(p){ let t=0; for(const k of Object.keys(DATA.postos?.[p]||{})) t+=Number(DATA.postos[p][k].fila||0); return t; }
    function somaGeralFila(){ let t=0; for(const p of Object.keys(DATA.postos||{})) t+=somaPostoTodos(p); return t; }

    function populaFiltros(){
      elPosto.innerHTML=''; const optAll=document.createElement('option'); optAll.value='__ALL__'; optAll.textContent='Todos os postos'; elPosto.appendChild(optAll);
      for(const p of getPostos()){ const o=document.createElement('option'); o.value=p; o.textContent=p; elPosto.appendChild(o); }
      elMes.innerHTML=''; for(const m of getMeses()){ const o=document.createElement('option'); o.value=m; o.textContent=labelMes(m); elMes.appendChild(o); }
      const hash=new URLSearchParams(location.hash.replace(/^#/,'')); const hp=hash.get('posto'), hm=hash.get('mes');
      elPosto.value=(hp && (hp==='__ALL__' || getPostos().includes(hp)))?hp:'__ALL__';
      elMes.value=(hm && getMeses().includes(hm))?hm:(getMeses()[0]||'');
      atualizaChips();
    }
    function atualizaChips(){
      elPPosto.textContent='Posto: '+(elPosto.value==='__ALL__'?'Todos':elPosto.value);
      elPMes.textContent='M√™s: '+labelMes(elMes.value||'‚Äî');
      elPStamp.textContent='Atualizado: '+(DATA?.atualizado_em?stamp(DATA.atualizado_em):'‚Äî');
      const p=new URLSearchParams(); p.set('posto',elPosto.value); p.set('mes',elMes.value); history.replaceState(null,'','#'+p.toString());
    }

    function render(){
      elErr.style.display='none';
      const posto=elPosto.value, mes=elMes.value;
      if(!mes){ elErr.textContent='Nenhum m√™s encontrado no data.json.'; elErr.style.display='block'; }
      // Em espera (m√™s)
      const filaMes = (posto==='__ALL__') ? somaMesFila(mes) : somaPostoMes(posto, mes);
      animate(elFilaMes, filaMes);
      elFilaMesObs.textContent = (posto==='__ALL__') ? 'Soma de todos os postos no m√™s selecionado.' : 'Total do posto no m√™s selecionado.';
      // Agendados total (fixo)
      animate(elAgTotal, Number(DATA.agendados_total||0));
      // Acumulado do posto
      if(posto==='__ALL__'){ elPostoAcum.textContent='‚Äî'; elPostoAcumObs.textContent='Selecione um posto espec√≠fico para ver o acumulado.'; }
      else { const a=somaPostoTodos(posto); animate(elPostoAcum,a); elPostoAcumObs.textContent='Soma de todos os meses do posto selecionado.'; }
      // Acumulado geral
      const g=somaGeralFila(); animate(elGeralAcum,g); elGeralAcumObs.textContent='Soma de todos os postos em todos os meses.';
      // Resumo por posto
      const arr=Object.keys(DATA.postos||{}).map(p=>[p,somaPostoTodos(p)]).sort((a,b)=>b[1]-a[1]);
      elResumo.innerHTML=''; for(const [name,total] of arr){ const row=document.createElement('div'); row.className='row'; row.innerHTML=`<b>${name}</b><span>${total}</span>`; elResumo.appendChild(row); }
    }

    async function loadData(){
      try{
        const res=await fetch(`data.json?cb=${Date.now()}`); if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const txt=await res.text(); try{ DATA=JSON.parse(txt); }catch(e){ throw new Error('JSON inv√°lido: '+e.message); }
        populaFiltros(); render();
      }catch(e){ elErr.textContent='N√£o foi poss√≠vel carregar os dados. Verifique se o data.json est√° no mesmo diret√≥rio. Detalhe: '+e.message; elErr.style.display='block'; }
    }
    elPosto.addEventListener('change', ()=>{ atualizaChips(); render(); });
    elMes.addEventListener('change',   ()=>{ atualizaChips(); render(); });
    elBtn.addEventListener('click', loadData);
    loadData(); setInterval(loadData, 60000);
  </script>
</body>
</html>
