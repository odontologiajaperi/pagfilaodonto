<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Fila de Pacientes â€” Painel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#111827; --line:#1f2937;
      --fg:#e5e7eb; --muted:#9aa4b2; --brand:#60a5fa; --ok:#10b981; --warn:#f59e0b;
    }
    *{box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:20px}
    h1{font-size:clamp(20px,3.5vw,28px);margin:0;font-weight:800;letter-spacing:.2px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius:20px; padding:20px}
    .toolbar{display:grid;grid-template-columns:1fr 1fr auto; gap:12px; margin-bottom:16px}
    @media (max-width:640px){ .toolbar{grid-template-columns:1fr} }
    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
    select,button{width:100%;appearance:none;border:1px solid var(--line);background:#0c1323;color:var(--fg);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    select:hover,button:hover{border-color:#324155}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    @media (max-width:640px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px}
    .label{font-size:14px;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:8px}
    .value{font-size:clamp(44px,8vw,72px);font-weight:900;line-height:1}
    .value.ok{color:var(--ok)}
    .value.brand{color:var(--brand)}
    .sub{font-size:14px;color:var(--muted);margin-top:10px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:16px;color:var(--muted);font-size:14px;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#0c1323}
    .err{color:#ef4444}
    .hint{font-size:13px;color:var(--muted)}
    .small{font-size:13px}
    .sectionTitle{margin:18px 2px 8px;font-size:15px;color:var(--muted);font-weight:700;letter-spacing:.3px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ“Š Painel â€” Fila de Pacientes</h1>
      <div class="hint">Selecione o <b>Posto</b> e o <b>MÃªs</b> para ver os totais.</div>
    </header>

    <div class="panel">
      <!-- Filtros -->
      <div class="toolbar">
        <div>
          <label for="postoSelect">Posto</label>
          <select id="postoSelect"></select>
        </div>
        <div>
          <label for="mesSelect">MÃªs</label>
          <select id="mesSelect"></select>
        </div>
        <div style="align-self:end;display:flex;gap:8px">
          <button id="refreshBtn" title="Recarregar agora">Recarregar</button>
        </div>
      </div>

      <!-- Contexto selecionado -->
      <div class="footer" style="margin-top:0;margin-bottom:10px">
        <div class="pill" id="pillPosto">Posto: â€”</div>
        <div class="pill" id="pillMes">MÃªs: â€”</div>
        <div class="pill" id="pillStamp">Atualizado: â€”</div>
      </div>

      <!-- MÃªs selecionado -->
      <div class="sectionTitle">Totais do mÃªs selecionado</div>
      <div class="grid">
        <div class="card">
          <div class="label">ğŸ•’ Fila de espera</div>
          <div id="fila" class="value brand">â€”</div>
          <div id="filaObs" class="sub"></div>
        </div>
        <div class="card">
          <div class="label">ğŸ“… Agendados</div>
          <div id="agendados" class="value ok">â€”</div>
          <div id="agObs" class="sub"></div>
        </div>
      </div>

      <!-- Acumulados -->
      <div class="sectionTitle">Acumulados</div>
      <div class="grid" id="gridAcum">
        <div class="card">
          <div class="label">ğŸ¥ Fila â€” Acumulado do posto (todos os meses)</div>
          <div id="postoAcumFila" class="value brand">â€”</div>
          <div id="postoAcumFilaObs" class="sub"></div>
        </div>
        <div class="card">
          <div class="label">ğŸ¥ Agendados â€” Acumulado do posto (todos os meses)</div>
          <div id="postoAcumAg" class="value ok">â€”</div>
          <div id="postoAcumAgObs" class="sub"></div>
        </div>
        <div class="card">
          <div class="label">ğŸŒ Fila â€” Acumulado geral (todos os postos + meses)</div>
          <div id="geralAcumFila" class="value brand">â€”</div>
          <div id="geralAcumFilaObs" class="sub"></div>
        </div>
        <div class="card">
          <div class="label">ğŸŒ Agendados â€” Acumulado geral (todos os postos + meses)</div>
          <div id="geralAcumAg" class="value ok">â€”</div>
          <div id="geralAcumAgObs" class="sub"></div>
        </div>
      </div>

      <!-- Mensagens -->
      <div id="error" class="sub err" style="margin-top:14px; display:none;"></div>
      <div class="footer">
        <div class="small">Auto-atualiza a cada 60s.</div>
        <div class="small">Dica: para inserir dados de um mÃªs novo, adicione a chave <code>YYYY-MM</code> no <code>data.json</code>.</div>
      </div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);

    // Elementos
    const elFila = $('#fila'), elAg = $('#agendados');
    const elFilaObs = $('#filaObs'), elAgObs = $('#agObs');
    const elErr = $('#error');
    const elPosto = $('#postoSelect'), elMes = $('#mesSelect');
    const elPillPosto = $('#pillPosto'), elPillMes = $('#pillMes'), elPillStamp = $('#pillStamp');
    const btn = $('#refreshBtn');

    // Acumulados
    const elPostoAcumFila = $('#postoAcumFila');
    const elPostoAcumAg   = $('#postoAcumAg');
    const elGeralAcumFila = $('#geralAcumFila');
    const elGeralAcumAg   = $('#geralAcumAg');
    const elPostoAcumFilaObs = $('#postoAcumFilaObs');
    const elPostoAcumAgObs   = $('#postoAcumAgObs');
    const elGeralAcumFilaObs = $('#geralAcumFilaObs');
    const elGeralAcumAgObs   = $('#geralAcumAgObs');

    let DATA = null;

    const ptMes = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"];
    const fmtStamp = iso => {
      try{
        const d = new Date(iso);
        const two = n => String(n).padStart(2,'0');
        return `${two(d.getDate())}/${two(d.getMonth()+1)}/${d.getFullYear()} ${two(d.getHours())}:${two(d.getMinutes())}`;
      }catch{ return 'â€”'; }
    };
    const labelMes = ym => /^\d{4}-\d{2}$/.test(ym) ? `${ptMes[Number(ym.slice(5,7))-1]}/${ym.slice(0,4)}` : ym;

    function animateCounter(el, to){
      const from = Number(el.textContent.replace(/\D/g,'')) || 0;
      const target = Number(to) || 0;
      const diff = target - from;
      const steps = 16;
      if (diff === 0){ el.textContent = String(target); return; }
      let i = 0;
      const tick = () => {
        i++;
        const val = Math.round(from + diff*(i/steps));
        el.textContent = String(val);
        if (i < steps) requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    }

    function getPostos(){ return Object.keys(DATA.postos || {}).sort((a,b)=>a.localeCompare(b,'pt')); }
    function getMeses(){
      const set = new Set();
      for(const p of Object.values(DATA.postos||{})) for(const k of Object.keys(p)) set.add(k);
      return Array.from(set).sort().reverse();
    }
    function sumAllForMonth(ym){
      let fila=0, ag=0;
      for(const p of Object.values(DATA.postos||{})){
        if(p[ym]){ fila += Number(p[ym].fila||0); ag += Number(p[ym].agendados||0); }
      }
      return {fila, agendados: ag};
    }
    function sumPostoAllMonths(posto){
      let fila=0, ag=0;
      const reg = DATA.postos?.[posto] || {};
      for(const k of Object.keys(reg)){
        fila += Number(reg[k].fila||0);
        ag   += Number(reg[k].agendados||0);
      }
      return {fila, agendados: ag};
    }
    function sumAllPostosAllMonths(){
      let fila=0, ag=0;
      for(const posto of Object.keys(DATA.postos||{})){
        const s = sumPostoAllMonths(posto);
        fila += s.fila; ag += s.agendados;
      }
      return {fila, agendados: ag};
    }

    function populateFilters(){
      elPosto.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '__ALL__'; optAll.textContent = 'Todos os postos';
      elPosto.appendChild(optAll);
      for(const p of getPostos()){
        const o = document.createElement('option'); o.value = p; o.textContent = p; elPosto.appendChild(o);
      }
      elMes.innerHTML='';
      for(const ym of getMeses()){
        const o = document.createElement('option'); o.value = ym; o.textContent = labelMes(ym); elMes.appendChild(o);
      }
      const hash = new URLSearchParams(location.hash.replace(/^#/, ''));
      const postoHash = hash.get('posto'); const mesHash = hash.get('mes');
      elPosto.value = (postoHash && (postoHash==='__ALL__' || getPostos().includes(postoHash))) ? postoHash : '__ALL__';
      elMes.value = (mesHash && getMeses().includes(mesHash)) ? mesHash : (getMeses()[0] || '');
      updatePills();
    }

    function updatePills(){
      elPillPosto.textContent = 'Posto: ' + (elPosto.value==='__ALL__' ? 'Todos' : elPosto.value);
      elPillMes.textContent = 'MÃªs: ' + labelMes(elMes.value || 'â€”');
      elPillStamp.textContent = 'Atualizado: ' + fmtStamp(DATA.atualizado_em || new Date().toISOString());
      const params = new URLSearchParams(); params.set('posto', elPosto.value); params.set('mes', elMes.value);
      history.replaceState(null,'', '#'+params.toString());
    }

    function render(){
      elErr.style.display='none';
      const posto = elPosto.value;
      const ym = elMes.value;
      if(!ym){
        elErr.textContent = 'Nenhum mÃªs encontrado no data.json.'; elErr.style.display='block';
        ['fila','agendados','postoAcumFila','postoAcumAg','geralAcumFila','geralAcumAg'].forEach(id => { const e = document.getElementById(id); if(e) e.textContent='0'; });
        return;
      }

      // MÃªs selecionado
      let filaMes=0, agMes=0, obsFila='', obsAg='';
      if(posto === '__ALL__'){
        const tot = sumAllForMonth(ym);
        filaMes = tot.fila; agMes = tot.agendados;
        obsFila = 'Soma de todos os postos no mÃªs selecionado.';
        obsAg   = 'Soma de todos os postos no mÃªs selecionado.';
      }else{
        const reg = (DATA.postos?.[posto] || {})[ym];
        if(!reg){
          filaMes = 0; agMes = 0;
          obsFila = 'Sem dados para este mÃªs no posto selecionado.';
          obsAg   = 'Sem dados para este mÃªs no posto selecionado.';
        }else{
          filaMes = Number(reg.fila||0); agMes = Number(reg.agendados||0);
          obsFila = 'Totais do posto no mÃªs selecionado.';
          obsAg   = 'Totais do posto no mÃªs selecionado.';
        }
      }
      animateCounter(elFila, filaMes); elFilaObs.textContent = obsFila;
      animateCounter(elAg, agMes);     elAgObs.textContent   = obsAg;

      // Acumulado do posto (todos meses)
      if(posto === '__ALL__'){
        elPostoAcumFila.textContent = 'â€”';
        elPostoAcumAg.textContent   = 'â€”';
        elPostoAcumFilaObs.textContent = 'Selecione um posto especÃ­fico para ver o acumulado.';
        elPostoAcumAgObs.textContent   = 'Selecione um posto especÃ­fico para ver o acumulado.';
      }else{
        const sp = sumPostoAllMonths(posto);
        animateCounter(elPostoAcumFila, sp.fila);
        animateCounter(elPostoAcumAg,   sp.agendados);
        elPostoAcumFilaObs.textContent = 'Soma de todos os meses do posto selecionado.';
        elPostoAcumAgObs.textContent   = 'Soma de todos os meses do posto selecionado.';
      }

      // Acumulado geral (todos postos + meses)
      const sg = sumAllPostosAllMonths();
      animateCounter(elGeralAcumFila, sg.fila);
      animateCounter(elGeralAcumAg,   sg.agendados);
      elGeralAcumFilaObs.textContent = 'Soma de todos os postos em todos os meses.';
      elGeralAcumAgObs.textContent   = 'Soma de todos os postos em todos os meses.';
    }

    async function loadData(){
      elErr.style.display='none';
      try{
        const res = await fetch(`data.json?cb=${Date.now()}`);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        try{
          DATA = JSON.parse(text);
        }catch(parseErr){
          throw new Error('JSON invÃ¡lido: ' + (parseErr?.message || 'erro ao parsear'));
        }
        populateFilters();
        render();
      }catch(e){
        elErr.textContent = 'NÃ£o foi possÃ­vel carregar os dados. Verifique se o data.json estÃ¡ no mesmo diretÃ³rio. Detalhe: ' + e.message;
        elErr.style.display='block';
      }
    }

    elPosto.addEventListener('change', ()=>{ updatePills(); render(); });
    elMes.addEventListener('change',   ()=>{ updatePills(); render(); });
    btn.addEventListener('click', loadData);

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
