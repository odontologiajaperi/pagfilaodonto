<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Painel ‚Äî Sa√∫de Bucal Japeri</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Inter:wght@500;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#EAF5FF; --panel:#FFFFFF; --line:#DDEAF7; --fg:#1B304A; --muted:#6B87A4;
      --brand-blue:#0F8BD6; --yellow:#FFF070; --chip:#F3FAFF;
      --big1:#15a0d6; --big2:#1DC56F;
    }
    *{box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
    .wrap{max-width:1060px;margin:0 auto;padding:20px}

    /* HERO */
    .hero{position:relative;border:1px solid var(--line);border-radius:24px;background:linear-gradient(180deg,#F7FBFF 0%,#F0F8FF 100%);padding:18px 20px 14px;overflow:hidden;margin-bottom:14px}
    .hero-top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .hero-brand{display:flex;align-items:center;gap:14px}
    .hero-brand img{height:56px;width:auto;object-fit:contain}
    .hero-title-text{font-size:14px;color:var(--muted)}
    .hero-logo{display:block;width:min(90%, 460px);max-width:460px;height:auto;margin:10px auto 0}

    /* PAINEL */
    .panel{border:1px solid var(--line);background:var(--panel);border-radius:20px;padding:16px;margin-bottom:16px}

    /* TOP METRICS */
    .top-metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:16px}
    @media (max-width:700px){.top-metrics{grid-template-columns:1fr}}
    .bigcard{background:#fff;border:1px solid var(--line);border-radius:18px;padding:16px 18px;min-height:140px;display:flex;flex-direction:column;justify-content:space-between;box-shadow:0 6px 10px rgba(0,0,0,.02)}
    .bigcard-title{font-size:13px;color:var(--muted);margin-bottom:10px;display:flex;gap:6px;align-items:center}
    .big-number{font-size:clamp(48px,8vw,80px);font-weight:900;line-height:1;display:inline-block}
    .big1{color:var(--big1)} .big2{color:var(--big2)}
    .bigcard-foot{font-size:13px;color:var(--muted);margin-top:6px}

    /* TOOLBAR */
    .toolbar{display:grid;grid-template-columns:1fr 1fr auto;gap:12px;margin-bottom:10px}
    @media (max-width:700px){.toolbar{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
    select,button{width:100%;appearance:none;border:1px solid var(--line);background:#fff;color:var(--fg);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    select:focus,button:hover{outline:none;border-color:#cfe3f7}

    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:4px 2px 14px}
    .chip{background:var(--chip);border:1px solid var(--line);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:13px}

    .sectionTitle{margin:14px 2px 10px;font-size:14px;color:var(--muted);font-weight:800;letter-spacing:.3px}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media (max-width:700px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--line);background:#fff;border-radius:16px;padding:16px}
    .label{font-size:14px;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:8px}
    .value{font-size:clamp(32px,6vw,54px);font-weight:900;line-height:1;color:#15a0d6;letter-spacing:.4px;background:linear-gradient(0deg,#fff 0 40%, var(--yellow) 40% 100%);display:inline-block;padding:4px 8px;border-radius:10px}
    .sub{font-size:13px;color:var(--muted);margin-top:8px}

    .list{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:8px}
    @media (max-width:700px){.list{grid-template-columns:1fr}}
    .row{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
    .row b{font-weight:800}

    /* rodap√© */
    footer{margin-top:14px;padding:16px 0 6px;text-align:center;color:var(--muted);font-size:13px}
    footer img{height:46px;width:auto;display:block;margin:0 auto 8px}

    .error{color:#d64545;font-size:14px;display:none;margin-top:8px}
        /* === Overrides de t√≠tulos das caixas === */
/* T√≠tulos em negrito e cor escura */
    .label,
    .bigcard-title{
      font-weight: 800;         /* negrito */
      color: var(--fg);         /* troca do cinza para o texto principal */
    }
    
    /* Aumenta s√≥ os t√≠tulos das duas caixas principais (topo) */
    .bigcard-title{
      font-size: clamp(16px, 2.4vw, 20px);
    }

        /* T√≠tulos em negrito e cor escura */
    .label,
    .bigcard-title{
      font-weight: 800;
      color: var(--fg);
    }
    
    /* T√≠tulos das duas caixas principais (topo) um pouco maiores */
    .bigcard-title{
      font-size: clamp(16px, 2.4vw, 20px);
    }
    
    /* Aviso com e-mail */
    .notice{
      margin: 8px 0 16px;
      border: 1px solid var(--line);
      background: var(--chip);
      border-left: 6px solid var(--brand-blue);
      border-radius: 12px;
      padding: 12px 14px;
      color: var(--fg);
      font-size: 14px;
    }
    .notice a{
      color: var(--big1);
      font-weight: 800;
      text-decoration: none;
    }
    .notice a:hover{ text-decoration: underline; }

  </style>
</head>
<body>
  <div class="wrap">
    <!-- HERO: marca Japeri + Brasil Sorridente -->
    <section class="hero">
      <div class="hero-top">
        <div class="hero-brand">
          <!-- >>> AQUI troquei para o nome correto do arquivo: japeri-logo.png <<< -->
          <img src="japeri-logo.png" alt="Prefeitura de Japeri">
          <div class="hero-title-text">Sa√∫de Bucal ‚Ä¢ Painel de Acompanhamento</div>
        </div>
      </div>
      <!-- Logo Brasil Sorridente centralizada -->
      <img src="brasil-sorridente-logo.png" alt="Brasil Sorridente ‚Äî Sa√∫de Bucal no SUS" class="hero-logo">
    </section>

    <!-- PAINEL -->
    <section class="panel">
      <!-- 1) N√öMEROS PRINCIPAIS -->
      <div class="top-metrics">
        <div class="bigcard">
          <div class="bigcard-title">üü¶ Em espera ‚Äî Total</div>
          <div id="geralAcumFila" class="big-number big1">‚Äî</div>
          <div class="bigcard-foot">Soma de todos os postos em todos os meses registrados.</div>
        </div>
          <div class="notice">
        üì© Quer saber sua posi√ß√£o exata na fila?
        Fale com nossa equipe pelo e-mail
        <a href="mailto:odontologiajaperi@gmail.com">odontologiajaperi@gmail.com</a>.
          </div>
        <div class="bigcard">
          <div class="bigcard-title">üìÖ Agendados ‚Äî Total</div>
          <div id="agTotal" class="big-number big2">‚Äî</div>
          <div class="bigcard-foot">Total de pacientes com agendamento.</div>
        </div>
      </div>

      <!-- 2) FILTROS -->
      <div class="toolbar">
        <div>
          <label for="postoSelect">Posto</label>
          <select id="postoSelect"></select>
        </div>
        <div>
          <label for="mesSelect">M√™s</label>
          <select id="mesSelect"></select>
        </div>
        <div style="align-self:end;display:flex;gap:8px">
          <button id="refreshBtn">Recarregar</button>
        </div>
      </div>

      <!-- chips -->
      <div class="chips">
        <div class="chip" id="pillPosto">Posto: ‚Äî</div>
        <div class="chip" id="pillMes">M√™s: ‚Äî</div>
        <div class="chip" id="pillStamp">Atualizado: ‚Äî</div>
      </div>

      <!-- 3) DADOS DETALHADOS -->
      <div class="sectionTitle">Totais conforme o filtro</div>
      <div class="grid">
        <div class="card">
          <div class="label">üïí Em espera ‚Äî m√™s selecionado do posto</div>
          <div id="filaMes" class="value">‚Äî</div>
          <div id="filaMesObs" class="sub"></div>
        </div>
        <div class="card">
          <div class="label">üè• Em espera ‚Äî Total do posto</div>
          <div id="postoAcumFila" class="value">‚Äî</div>
          <div id="postoAcumFilaObs" class="sub"></div>
        </div>
      </div>

      <div class="sectionTitle">Resumo por posto (soma de todos os meses)</div>
      <div id="postoResumo" class="list"></div>

      <div id="error" class="error"></div>
    </section>

    <!-- RODAP√â COM LOGO -->
    <footer>
      <!-- >>> E aqui tamb√©m corrigi para japeri-logo.png <<< -->
      <img src="japeri-logo.png" alt="Prefeitura de Japeri">
      Painel interno de acompanhamento da Sa√∫de Bucal ‚Äî Prefeitura de Japeri
    </footer>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const elPosto = $('#postoSelect'), elMes = $('#mesSelect'), elBtn = $('#refreshBtn');
    const elPPosto = $('#pillPosto'), elPMes = $('#pillMes'), elPStamp = $('#pillStamp');
    const elFilaMes = $('#filaMes'), elFilaMesObs = $('#filaMesObs');
    const elPostoAcum = $('#postoAcumFila'), elPostoAcumObs = $('#postoAcumFilaObs');
    const elGeralAcum = $('#geralAcumFila');
    const elAgTotal = $('#agTotal');
    const elResumo = $('#postoResumo');
    const elErr = $('#error');
    let DATA = null;

    const nomes=["","jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"];

    function parseRank(k){
      const m=/^(\d{4})-(\d{2})(?:-(\d{2}))?$/.exec(k);
      if(m){const y=+m[1], m1=+m[2], m2=m[3]?+m[3]:null;return y*12+m1+(m2?0.5:0);}
      const s=k.toLowerCase();
      if(/fev/.test(s))return 2; if(/mar/.test(s))return 3; if(/mai/.test(s))return 5;
      if(/jun/.test(s))return 6; if(/jul.*ago|jul\/ago|jul-ago/.test(s))return 7.5;
      if(/ago/.test(s))return 8; if(/set/.test(s))return 9; return 0;
    }
    function labelMes(k){
      const m=/^(\d{4})-(\d{2})(?:-(\d{2}))?$/.exec(k);
      if(m){const y=m[1], m1=+m[2], m2=m[3]?+m[3]:null;return m2?`${nomes[m1]}+${nomes[m2]}/${y}`:`${nomes[m1]}/${y}`;}
      return k;
    }
    function stamp(iso){
      try{const d=new Date(iso);const two=n=>String(n).padStart(2,'0');return `${two(d.getDate())}/${two(d.getMonth()+1)}/${d.getFullYear()} ${two(d.getHours())}:${two(d.getMinutes())}`;}
      catch{return '‚Äî'}
    }
    function animate(el,to){
      const from=Number(el.textContent.replace(/\D/g,''))||0;
      const target=Number(to)||0;
      const diff=target-from;
      const steps=16;
      if(diff===0){el.textContent=String(target);return;}
      let i=0;
      const tick=()=>{i++;el.textContent=String(Math.round(from+diff*(i/steps)));if(i<steps)requestAnimationFrame(tick);};
      requestAnimationFrame(tick);
    }

    function getPostos(){ return Object.keys(DATA.postos||{}).sort((a,b)=>a.localeCompare(b,'pt')); }
    function getMeses(){
      const set=new Set();
      for(const p of Object.values(DATA.postos||{})) for(const k of Object.keys(p)) set.add(k);
      return [...set].sort((a,b)=>parseRank(b)-parseRank(a));
    }
    function somaPostoMes(p,m){ return Number((DATA.postos?.[p]||{})[m]?.fila||0); }
    function somaMesFila(m){ let t=0; for(const p of Object.keys(DATA.postos||{})) t+=somaPostoMes(p,m); return t; }
    function somaPostoTodos(p){ let t=0; for(const k of Object.keys(DATA.postos?.[p]||{})) t+=Number(DATA.postos[p][k].fila||0); return t; }
    function somaGeralFila(){ let t=0; for(const p of Object.keys(DATA.postos||{})) t+=somaPostoTodos(p); return t; }

    function populaFiltros(){
      elPosto.innerHTML='';
      const optAll=document.createElement('option');
      optAll.value='__ALL__'; optAll.textContent='Todos os postos';
      elPosto.appendChild(optAll);
      for(const p of getPostos()){
        const o=document.createElement('option');o.value=p;o.textContent=p;elPosto.appendChild(o);
      }
      elMes.innerHTML='';
      for(const m of getMeses()){
        const o=document.createElement('option');o.value=m;o.textContent=labelMes(m);elMes.appendChild(o);
      }
      const hash=new URLSearchParams(location.hash.replace(/^#/,''));const hp=hash.get('posto'), hm=hash.get('mes');
      elPosto.value=(hp && (hp==='__ALL__' || getPostos().includes(hp)))?hp:'__ALL__';
      elMes.value=(hm && getMeses().includes(hm))?hm:(getMeses()[0]||'');
      atualizaChips();
    }
    function atualizaChips(){
      elPPosto.textContent='Posto: '+(elPosto.value==='__ALL__'?'Todos':elPosto.value);
      elPMes.textContent='M√™s: '+labelMes(elMes.value||'‚Äî');
      elPStamp.textContent='Atualizado: '+(DATA?.atualizado_em?stamp(DATA.atualizado_em):'‚Äî');
      const p=new URLSearchParams();p.set('posto',elPosto.value);p.set('mes',elMes.value);history.replaceState(null,'','#'+p.toString());
    }

    function render(){
      elErr.style.display='none';
      const posto=elPosto.value, mes=elMes.value;

      // top: acumulado geral
      animate(elGeralAcum, somaGeralFila());

      // top: agendados total (fixo)
      animate(elAgTotal, Number(DATA.agendados_total || 0));

      if(!mes){
        elFilaMes.textContent='0';
        elFilaMesObs.textContent='Selecione um m√™s.';
        elPostoAcum.textContent='‚Äî';
        elPostoAcumObs.textContent='Selecione um posto.';
        return;
      }

      // m√™s selecionado
      const filaMes = (posto==='__ALL__') ? somaMesFila(mes) : somaPostoMes(posto, mes);
      animate(elFilaMes, filaMes);
      elFilaMesObs.textContent = (posto==='__ALL__') ? 'Somando todos os postos neste m√™s.' : 'Total deste posto no m√™s escolhido.';

      // acumulado do posto
      if(posto==='__ALL__'){
        elPostoAcum.textContent='‚Äî';
        elPostoAcumObs.textContent='Escolha um posto para ver o total dele.';
      }else{
        const a = somaPostoTodos(posto);
        animate(elPostoAcum, a);
        elPostoAcumObs.textContent='Somando todos os meses registrados para este posto.';
      }

      // resumo por posto
      const arr = Object.keys(DATA.postos||{}).map(p=>[p,somaPostoTodos(p)]).sort((a,b)=>b[1]-a[1]);
      elResumo.innerHTML='';
      for(const [name,total] of arr){
        const row=document.createElement('div');row.className='row';
        row.innerHTML=`<b>${name}</b><span>${total}</span>`;
        elResumo.appendChild(row);
      }
    }

    async function loadData(){
      try{
        const res=await fetch(`data.json?cb=${Date.now()}`);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const txt=await res.text();
        try{ DATA=JSON.parse(txt); }catch(e){ throw new Error('JSON inv√°lido: '+e.message); }
        populaFiltros();
        render();
      }catch(e){
        elErr.textContent='N√£o foi poss√≠vel carregar os dados. Veja se o "data.json" est√° na mesma pasta. Detalhe: '+e.message;
        elErr.style.display='block';
      }
    }

    elPosto.addEventListener('change', ()=>{atualizaChips();render();});
    elMes.addEventListener('change',   ()=>{atualizaChips();render();});
    elBtn.addEventListener('click', loadData);

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
