<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Painel ‚Äî Fila de Pacientes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#111827; --line:#1f2937;
      --fg:#e5e7eb; --muted:#9aa4b2; --brand:#60a5fa; --ok:#10b981;
    }
    *{box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:20px}
    h1{font-size:clamp(20px,3.5vw,28px);margin:0;font-weight:800;letter-spacing:.2px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius:20px; padding:20px}
    .toolbar{display:grid;grid-template-columns:1fr 1fr auto; gap:12px; margin-bottom:16px}
    @media (max-width:640px){ .toolbar{grid-template-columns:1fr} }
    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
    select,button{width:100%;appearance:none;border:1px solid var(--line);background:#0c1323;color:var(--fg);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    select:hover,button:hover{border-color:#324155}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    @media (max-width:640px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px}
    .label{font-size:14px;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:8px}
    .value{font-size:clamp(44px,8vw,72px);font-weight:900;line-height:1}
    .value.brand{color:var(--brand)}
    .sub{font-size:14px;color:var(--muted);margin-top:10px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:16px;color:var(--muted);font-size:14px;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#0c1323}
    .hint{font-size:13px;color:var(--muted)}
    .small{font-size:13px}
    .sectionTitle{margin:18px 2px 8px;font-size:15px;color:var(--muted);font-weight:700;letter-spacing:.3px}
    .list{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:8px}
    @media (max-width:640px){ .list{grid-template-columns:1fr} }
    .row{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#0c1323}
    .row b{font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üìä Painel ‚Äî Fila de Pacientes</h1>
      <div class="hint">Selecione o <b>Posto</b> e o <b>M√™s</b>. Os n√∫meros s√£o atualizados manualmente.</div>
    </header>

    <div class="panel">
      <!-- Filtros -->
      <div class="toolbar">
        <div>
          <label for="postoSelect">Posto</label>
          <select id="postoSelect"></select>
        </div>
        <div>
          <label for="mesSelect">M√™s</label>
          <select id="mesSelect"></select>
        </div>
        <div style="align-self:end;display:flex;gap:8px">
          <button id="refreshBtn" title="Recarregar agora">Recarregar</button>
        </div>
      </div>

      <!-- Contexto selecionado -->
      <div class="footer" style="margin-top:0;margin-bottom:10px">
        <div class="pill" id="pillPosto">Posto: ‚Äî</div>
        <div class="pill" id="pillMes">M√™s: ‚Äî</div>
        <div class="pill" id="pillStamp">Atualizado: ‚Äî</div>
      </div>

      <!-- M√™s selecionado -->
      <div class="sectionTitle">Total do m√™s selecionado</div>
      <div class="grid">
        <div class="card">
          <div class="label">üïí Em espera</div>
          <div id="filaMes" class="value brand">‚Äî</div>
          <div id="filaMesObs" class="sub"></div>
        </div>
      </div>

      <!-- Acumulados -->
      <div class="sectionTitle">Acumulados</div>
      <div class="grid">
        <div class="card">
          <div class="label">üè• Em espera ‚Äî Acumulado do posto (todos os meses)</div>
          <div id="postoAcumFila" class="value brand">‚Äî</div>
          <div id="postoAcumFilaObs" class="sub"></div>
        </div>
        <div class="card">
          <div class="label">üåé Em espera ‚Äî Acumulado geral (todos os postos + meses)</div>
          <div id="geralAcumFila" class="value brand">‚Äî</div>
          <div id="geralAcumFilaObs" class="sub"></div>
        </div>
      </div>

      <!-- Resumo por posto -->
      <div class="sectionTitle">Resumo por posto (em espera ‚Äî soma de todos os meses)</div>
      <div id="postoResumo" class="list"></div>

      <!-- Mensagens -->
      <div id="error" class="sub" style="margin-top:14px; color:#ef4444; display:none;"></div>
      <div class="footer">
        <div class="small">Auto-atualiza a cada 60s.</div>
        <div class="small">Para m√™s combinado (ex.: Jul/agos), usamos a chave <code>YYYY-07-08</code>.</div>
      </div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);

    // Elementos
    const elErr = $('#error');
    const elPosto = $('#postoSelect'), elMes = $('#mesSelect');
    const elPillPosto = $('#pillPosto'), elPillMes = $('#pillMes'), elPillStamp = $('#pillStamp');
    const elFilaMes = $('#filaMes'), elFilaMesObs = $('#filaMesObs');
    const elPostoAcumFila = $('#postoAcumFila'), elPostoAcumFilaObs = $('#postoAcumFilaObs');
    const elGeralAcumFila = $('#geralAcumFila'), elGeralAcumFilaObs = $('#geralAcumFilaObs');
    const elResumo = $('#postoResumo');
    const btn = $('#refreshBtn');

    let DATA = null;

    // ---- Helpers de m√™s (suporta "YYYY-MM" e "YYYY-MM-MM") ----
    function parseKeyRank(k){
      // "2025-07-08" -> rank = 2025*12 + 7 + 0.5
      const m = /^(\d{4})-(\d{2})(?:-(\d{2}))?$/.exec(k);
      if(m){
        const y = Number(m[1]), m1 = Number(m[2]), m2 = m[3] ? Number(m[3]) : null;
        return y*12 + m1 + (m2 ? 0.5 : 0);
      }
      // fallback por nome (fev, mar, maio, junho, jul/agos, setembro)
      const s = k.toLowerCase();
      if(/fev|fevereiro/.test(s)) return 2;
      if(/mar|mar√ß/.test(s)) return 3;
      if(/mai|maio/.test(s)) return 5;
      if(/jun/.test(s)) return 6;
      if(/jul.*ago|jul\/agos|jul\/ago|jul-ago/.test(s)) return 7.5;
      if(/ago|agost/.test(s)) return 8;
      if(/set|setembro/.test(s)) return 9;
      return 0; // desconhecido
    }
    function labelMes(k){
      const m = /^(\d{4})-(\d{2})(?:-(\d{2}))?$/.exec(k);
      const nomes = ["","jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"];
      if(m){
        const y = m[1], m1 = Number(m[2]), m2 = m[3] ? Number(m[3]) : null;
        if(m2) return `${nomes[m1]}+${nomes[m2]}/${y}`;
        return `${nomes[m1]}/${y}`;
      }
      return k; // r√≥tulo bruto
    }

    function animateCounter(el, to){
      const from = Number(el.textContent.replace(/\D/g,'')) || 0;
      const target = Number(to) || 0;
      const diff = target - from;
      const steps = 16;
      if (diff === 0){ el.textContent = String(target); return; }
      let i = 0;
      const tick = () => {
        i++;
        const val = Math.round(from + diff*(i/steps));
        el.textContent = String(val);
        if (i < steps) requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    }

    function getPostos(){
      return Object.keys(DATA.postos || {}).sort((a,b)=>a.localeCompare(b,'pt'));
    }
    function getMeses(){
      const set = new Set();
      for(const p of Object.values(DATA.postos||{})) for(const k of Object.keys(p)) set.add(k);
      const arr = Array.from(set);
      // Ordena do mais recente para o mais antigo (rank desc)
      arr.sort((a,b)=>parseKeyRank(b)-parseKeyRank(a));
      return arr;
    }

    function sumPostoMes(posto, ym){
      const reg = (DATA.postos?.[posto] || {})[ym];
      return Number(reg?.fila || 0);
    }
    function sumAllForMonth(ym){
      let fila=0;
      for(const p of Object.keys(DATA.postos||{})){
        fila += sumPostoMes(p, ym);
      }
      return fila;
    }
    function sumPostoAllMonths(posto){
      let fila=0;
      const reg = DATA.postos?.[posto] || {};
      for(const k of Object.keys(reg)) fila += Number(reg[k].fila || 0);
      return fila;
    }
    function sumAllPostosAllMonths(){
      let fila=0;
      for(const p of Object.keys(DATA.postos||{})) fila += sumPostoAllMonths(p);
      return fila;
    }
    function resumoPorPosto(){
      const arr = [];
      for(const p of Object.keys(DATA.postos||{})){
        arr.push([p, sumPostoAllMonths(p)]);
      }
      // Ordena por total desc
      arr.sort((a,b)=>b[1]-a[1]);
      return arr;
    }

    function populateFilters(){
      // Postos
      elPosto.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '__ALL__'; optAll.textContent = 'Todos os postos';
      elPosto.appendChild(optAll);
      for(const p of getPostos()){
        const o = document.createElement('option'); o.value = p; o.textContent = p; elPosto.appendChild(o);
      }
      // Meses
      elMes.innerHTML='';
      for(const ym of getMeses()){
        const o = document.createElement('option'); o.value = ym; o.textContent = labelMes(ym); elMes.appendChild(o);
      }
      // Defaults via hash
      const hash = new URLSearchParams(location.hash.replace(/^#/, ''));
      const postoHash = hash.get('posto'); const mesHash = hash.get('mes');
      elPosto.value = (postoHash && (postoHash==='__ALL__' || getPostos().includes(postoHash))) ? postoHash : '__ALL__';
      elMes.value   = (mesHash && getMeses().includes(mesHash)) ? mesHash : (getMeses()[0] || '');
      updatePills();
    }

    function updatePills(){
      elPillPosto.textContent = 'Posto: ' + (elPosto.value==='__ALL__' ? 'Todos' : elPosto.value);
      elPillMes.textContent   = 'M√™s: ' + labelMes(elMes.value || '‚Äî');
      elPillStamp.textContent = 'Atualizado: ' + (DATA?.atualizado_em ? formatStamp(DATA.atualizado_em) : '‚Äî');
      const params = new URLSearchParams(); params.set('posto', elPosto.value); params.set('mes', elMes.value);
      history.replaceState(null,'', '#'+params.toString());
    }

    function formatStamp(iso){
      try{
        const d = new Date(iso);
        const two = n => String(n).padStart(2,'0');
        return `${two(d.getDate())}/${two(d.getMonth()+1)}/${d.getFullYear()} ${two(d.getHours())}:${two(d.getMinutes())}`;
      }catch{ return '‚Äî'; }
    }

    function render(){
      elErr.style.display='none';
      const posto = elPosto.value;
      const ym = elMes.value;
      if(!ym){
        elErr.textContent = 'Nenhum m√™s encontrado no data.json.'; elErr.style.display='block';
        ['filaMes','postoAcumFila','geralAcumFila'].forEach(id => { const e = document.getElementById(id); if(e) e.textContent='0'; });
        elResumo.innerHTML='';
        return;
      }

      // Total do m√™s
      let filaMes = 0, obsMes = '';
      if(posto === '__ALL__'){
        filaMes = sumAllForMonth(ym);
        obsMes = 'Soma de todos os postos no m√™s selecionado.';
      }else{
        filaMes = sumPostoMes(posto, ym);
        obsMes = 'Total do posto no m√™s selecionado.';
      }
      animateCounter(elFilaMes, filaMes);
      elFilaMesObs.textContent = obsMes;

      // Acumulado do posto
      if(posto === '__ALL__'){
        elPostoAcumFila.textContent = '‚Äî';
        elPostoAcumFilaObs.textContent = 'Selecione um posto espec√≠fico para ver o acumulado.';
      }else{
        const sp = sumPostoAllMonths(posto);
        animateCounter(elPostoAcumFila, sp);
        elPostoAcumFilaObs.textContent = 'Soma de todos os meses do posto selecionado.';
      }

      // Acumulado geral
      const sg = sumAllPostosAllMonths();
      animateCounter(elGeralAcumFila, sg);
      elGeralAcumFilaObs.textContent = 'Soma de todos os postos em todos os meses.';

      // Resumo por posto
      const list = resumoPorPosto();
      elResumo.innerHTML = '';
      for(const [name,total] of list){
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `<b>${name}</b><span>${total}</span>`;
        elResumo.appendChild(row);
      }
    }

    async function loadData(){
      elErr.style.display='none';
      try{
        const res = await fetch(`data.json?cb=${Date.now()}`);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        try{
          DATA = JSON.parse(text);
        }catch(parseErr){
          throw new Error('JSON inv√°lido: ' + (parseErr?.message || 'erro ao interpretar'));
        }
        populateFilters();
        render();
      }catch(e){
        elErr.textContent = 'N√£o foi poss√≠vel carregar os dados. Verifique se o data.json est√° no mesmo diret√≥rio. Detalhe: ' + e.message;
        elErr.style.display='block';
      }
    }

    elPosto.addEventListener('change', ()=>{ updatePills(); render(); });
    elMes.addEventListener('change',   ()=>{ updatePills(); render(); });
    btn.addEventListener('click', loadData);

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
